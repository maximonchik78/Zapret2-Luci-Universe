name: Build LuCI Package

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download SDK (cached)
      id: sdk
      run: |
        # –°–∫–∞—á–∏–≤–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑ –∏ –∫—ç—à–∏—Ä—É–µ–º
        if [ ! -f "sdk.tar.xz" ]; then
          echo "üì• Downloading SDK..."
          wget -q --show-progress -O sdk.tar.xz \
            "https://downloads.openwrt.org/releases/23.05.3/targets/x86/64/openwrt-sdk-23.05.3-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
        fi
        
        mkdir -p sdk
        tar -xf sdk.tar.xz -C sdk --strip-components=1
        echo "‚úÖ SDK ready"
    
    - name: Copy package
      run: |
        # –ö–æ–ø–∏—Ä—É–µ–º –¢–û–õ–¨–ö–û –Ω—É–∂–Ω—ã–µ —Ñ–∞–π–ª—ã
        mkdir -p sdk/package/luci-app-zapret2
        
        # Makefile –û–ë–Ø–ó–ê–¢–ï–õ–ï–ù
        if [ ! -f "Makefile" ]; then
          echo "‚ùå Makefile not found! Create it first!"
          exit 1
        fi
        
        cp Makefile sdk/package/luci-app-zapret2/
        
        # –ö–æ–ø–∏—Ä—É–µ–º files –µ—Å–ª–∏ –µ—Å—Ç—å
        if [ -d "files" ]; then
          cp -r files sdk/package/luci-app-zapret2/
        fi
        
        echo "üìÅ Package structure:"
        ls -la sdk/package/luci-app-zapret2/
    
    - name: Build
      run: |
        cd sdk
        
        # 1. –û–±–Ω–æ–≤–ª—è–µ–º feeds
        ./scripts/feeds update -a
        
        # 2. –°—Ç–∞–≤–∏–º luci
        ./scripts/feeds install luci
        
        # 3. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º (defconfig —Å–∞–º –≤—Å—ë –¥–µ–ª–∞–µ—Ç)
        make defconfig
        
        # 4. –°–æ–±–∏—Ä–∞–µ–º –¢–û–õ–¨–ö–û –Ω–∞—à –ø–∞–∫–µ—Ç
        echo "üèóÔ∏è Building luci-app-zapret2..."
        make package/luci-app-zapret2/compile V=s 2>&1 | tee build.log
        
        # 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º
        if find bin -name "luci-app-zapret2*.ipk" 2>/dev/null | head -1; then
          echo "‚úÖ Build SUCCESS!"
          echo "IPK file:"
          find bin -name "*.ipk" -type f | xargs ls -la
        else
          echo "‚ùå Build FAILED"
          echo "Last errors:"
          tail -100 build.log | grep -i "error\|fail" | head -20
          exit 1
        fi
    
    - name: Upload artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: luci-app-zapret2
        path: sdk/bin/**/luci/luci-app-zapret2*.ipk
        retention-days: 7
