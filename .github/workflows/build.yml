name: Build LuCI Package for OpenWrt

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      target_arch:
        description: 'Target architecture'
        required: true
        default: 'x86_64'
        type: choice
        options:
          - x86_64
          - aarch64

env:
  OPENWRT_VERSION: "23.05.3"

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        target: [x86_64, aarch64]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache OpenWrt SDK
        uses: actions/cache@v3
        id: sdk-cache
        with:
          path: sdk-${{ matrix.target }}
          key: ${{ runner.os }}-sdk-${{ matrix.target }}-${{ env.OPENWRT_VERSION }}-v1

      - name: Download OpenWrt SDK
        if: steps.sdk-cache.outputs.cache-hit != 'true'
        run: |
          echo "üì• Downloading SDK for ${{ matrix.target }}..."
          
          case "${{ matrix.target }}" in
            x86_64)
              SDK_URL="https://downloads.openwrt.org/releases/${{ env.OPENWRT_VERSION }}/targets/x86/64/openwrt-sdk-${{ env.OPENWRT_VERSION }}-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
              ;;
            aarch64)
              SDK_URL="https://downloads.openwrt.org/releases/${{ env.OPENWRT_VERSION }}/targets/armvirt/64/openwrt-sdk-${{ env.OPENWRT_VERSION }}-aarch64_generic_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
              ;;
            *)
              echo "‚ùå Unsupported target"
              exit 1
              ;;
          esac
          
          echo "URL: $SDK_URL"
          
          # –°–∫–∞—á–∏–≤–∞–µ–º —Å —Ç–∞–π–º–∞—É—Ç–æ–º –∏ —Ä–µ—Ç—Ä–∞—è–º–∏
          for i in {1..3}; do
            if wget --timeout=30 --tries=3 --show-progress -O sdk.tar.xz "$SDK_URL"; then
              echo "‚úÖ Download successful"
              break
            elif [ $i -eq 3 ]; then
              echo "‚ùå Failed to download SDK after 3 attempts"
              exit 1
            fi
            echo "‚ö†Ô∏è Attempt $i failed, retrying..."
            sleep 5
          done
          
          # –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º
          mkdir -p sdk-${{ matrix.target }}
          tar -xf sdk.tar.xz -C sdk-${{ matrix.target }} --strip-components=1
          
          if [ -f "sdk-${{ matrix.target }}/Makefile" ]; then
            echo "‚úÖ SDK extracted successfully"
          else
            echo "‚ùå SDK extraction failed"
            ls -la sdk-${{ matrix.target }}/
            exit 1
          fi

      - name: Prepare package in SDK
        run: |
          echo "üìÅ Preparing package..."
          
          SDK_DIR="sdk-${{ matrix.target }}"
          
          # –í–ê–ñ–ù–û: –ö–æ–ø–∏—Ä—É–µ–º –°–û–î–ï–†–ñ–ò–ú–û–ï —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è, –∞ –Ω–µ —Å–∞–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø–∞–∫–µ—Ç–∞
          mkdir -p $SDK_DIR/package/luci-app-zapret2
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ —Ñ–∞–π–ª—ã (–∫–∞–∫ —É remittor)
          cp -r files $SDK_DIR/package/luci-app-zapret2/ 2>/dev/null || echo "‚ö†Ô∏è No files directory"
          cp Makefile $SDK_DIR/package/luci-app-zapret2/ 2>/dev/null || (echo "‚ùå Makefile not found" && exit 1)
          
          echo "‚úÖ Package prepared at: $SDK_DIR/package/luci-app-zapret2"
          ls -la $SDK_DIR/package/luci-app-zapret2/

      - name: Build package
        run: |
          SDK_DIR="sdk-${{ matrix.target }}"
          cd $SDK_DIR
          
          echo "üî® Building luci-app-zapret2..."
          
          # –û–±–Ω–æ–≤–ª—è–µ–º feeds (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)
          ./scripts/feeds update -a
          ./scripts/feeds install luci
          
          # –ü—Ä–æ—Å—Ç–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
          cat > .config << 'EOF'
          CONFIG_TARGET_x86=y
          CONFIG_TARGET_x86_64=y
          CONFIG_TARGET_x86_64_DEVICE_generic=y
          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_luci-base=y
          CONFIG_LUCI_LANG_ru=y
          CONFIG_LUCI_LANG_en=y
          EOF
          
          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º –∏ —Å–æ–±–∏—Ä–∞–µ–º
          make defconfig
          make package/luci-app-zapret2/compile V=s 2>&1 | tee build.log
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          if find bin -name "luci-app-zapret2*.ipk" 2>/dev/null | grep -q .; then
            echo "‚úÖ Build successful!"
            echo "üì¶ Generated packages:"
            find bin -name "luci-app-zapret2*.ipk" | while read ipk; do
              echo "  - $(basename $ipk) ($(du -h "$ipk" | cut -f1))"
            done
          else
            echo "‚ùå Build failed"
            echo "=== Last 50 lines of log ==="
            tail -50 build.log
            exit 1
          fi

      - name: Upload artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-zapret2-${{ matrix.target }}
          path: sdk-${{ matrix.target }}/bin/**/luci/luci-app-zapret2*.ipk
          retention-days: 7

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ matrix.target }}
          path: sdk-${{ matrix.target }}/build.log
          retention-days: 7
