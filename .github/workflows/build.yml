name: Build LuCI Package for OpenWrt

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      target_arch:
        description: 'Target architecture (x86_64, aarch64, mipsel)'
        required: true
        default: 'x86_64'

env:
  OPENWRT_VERSION: "23.05.3"

jobs:
  setup-sdk:
    runs-on: ubuntu-latest
    outputs:
      sdk_urls: ${{ steps.setup.outputs.sdk_urls }}
    steps:
      - name: Determine SDK URLs
        id: setup
        run: |
          # Map architectures to SDK URLs
          declare -A SDK_URLS=(
            ["x86_64"]="https://downloads.openwrt.org/releases/${{ env.OPENWRT_VERSION }}/targets/x86/64/openwrt-sdk-${{ env.OPENWRT_VERSION }}-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
            ["aarch64"]="https://downloads.openwrt.org/releases/${{ env.OPENWRT_VERSION }}/targets/armvirt/64/openwrt-sdk-${{ env.OPENWRT_VERSION }}-aarch64_generic_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
            ["mipsel"]="https://downloads.openwrt.org/releases/${{ env.OPENWRT_VERSION }}/targets/ramips/mt7621/openwrt-sdk-${{ env.OPENWRT_VERSION }}-ramips-mt7621_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
          )
          
          # Get architectures to build
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ARCHS="${{ github.event.inputs.target_arch }}"
          elif [[ "${{ github.event.ref }}" == refs/tags/* ]]; then
            # Build all architectures for tags
            ARCHS="x86_64 aarch64 mipsel"
          else
            # Build only x86_64 for regular pushes
            ARCHS="x86_64"
          fi
          
          # Prepare JSON output
          JSON="{"
          first=true
          for arch in $ARCHS; do
            if [[ ${SDK_URLS[$arch]} ]]; then
              if [ "$first" = false ]; then
                JSON="$JSON,"
              fi
              JSON="$JSON\"$arch\":\"${SDK_URLS[$arch]}\""
              first=false
            else
              echo "‚ö†Ô∏è Warning: No SDK URL for architecture $arch" >&2
            fi
          done
          JSON="$JSON}"
          
          if [ "$JSON" = "{}" ]; then
            echo "‚ùå No valid architectures specified"
            exit 1
          fi
          
          echo "SDK_URLS=$JSON" >> $GITHUB_OUTPUT
          echo "Architectures to build: $ARCHS"

  build:
    needs: setup-sdk
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: ${{ fromJson(needs.setup-sdk.outputs.sdk_urls) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show environment info
        run: |
          echo "üîÑ Build started for ${{ matrix.arch.key }}"
          echo "SDK URL: ${{ matrix.arch.value }}"
          echo "Working directory: $(pwd)"
          ls -la

      - name: Download OpenWrt SDK
        run: |
          echo "üì• Downloading SDK for ${{ matrix.arch.key }}..."
          SDK_URL='${{ matrix.arch.value }}'
          
          # Create directory
          mkdir -p sdk-${{ matrix.arch.key }}
          
          # Download with retry
          for i in {1..3}; do
            echo "Attempt $i to download SDK..."
            if wget -q --show-progress -O sdk.tar.xz "$SDK_URL"; then
              echo "‚úÖ Download successful"
              break
            elif [ $i -eq 3 ]; then
              echo "‚ùå Failed to download SDK after 3 attempts"
              exit 1
            fi
            sleep 5
          done
          
          # Extract
          echo "üì¶ Extracting SDK..."
          if tar -xf sdk.tar.xz -C sdk-${{ matrix.arch.key }} --strip-components=1; then
            echo "‚úÖ Extraction successful"
          else
            echo "‚ùå Failed to extract SDK"
            exit 1
          fi
          
          # Verify
          SDK_DIR="sdk-${{ matrix.arch.key }}"
          if [ -f "$SDK_DIR/Makefile" ] && [ -d "$SDK_DIR/package" ]; then
            echo "‚úÖ SDK verified:"
            ls -la "$SDK_DIR/"
          else
            echo "‚ùå SDK verification failed"
            ls -la "$SDK_DIR/"
            exit 1
          fi

      - name: Prepare package
        run: |
          SDK_DIR="sdk-${{ matrix.arch.key }}"
          
          # Check package structure
          echo "üìÅ Checking package structure..."
          if [ -f "Makefile" ]; then
            echo "‚úÖ Makefile found"
            head -20 Makefile
          else
            echo "‚ùå Makefile not found"
            exit 1
          fi
          
          # Copy package to SDK
          echo "üìã Copying package to SDK tree..."
          mkdir -p "$SDK_DIR/package/luci-app-zapret2"
          cp -r Makefile files "$SDK_DIR/package/luci-app-zapret2/" 2>/dev/null || true
          
          # Copy any other necessary files
          for file in README.md LICENSE; do
            if [ -f "$file" ]; then
              cp "$file" "$SDK_DIR/package/luci-app-zapret2/" 2>/dev/null || true
            fi
          done
          
          echo "‚úÖ Package prepared in $SDK_DIR/package/luci-app-zapret2/"
          ls -la "$SDK_DIR/package/luci-app-zapret2/"

      - name: Build package
        run: |
          SDK_DIR="sdk-${{ matrix.arch.key }}"
          cd "$SDK_DIR"
          
          echo "üî® Starting build process..."
          
          # Update feeds
          echo "üì° Updating feeds..."
          ./scripts/feeds update -a
          
          # Install luci feed
          ./scripts/feeds install luci
          
          # Configure
          echo "‚öôÔ∏è Configuring build..."
          make defconfig 2>&1 | tee config.log || echo "‚ö†Ô∏è defconfig may have warnings"
          
          # Build package
          echo "üèóÔ∏è Building luci-app-zapret2..."
          
          # Build with error capture
          set +e
          make package/luci-app-zapret2/compile V=sc 2>&1 | tee build.log
          BUILD_EXIT_CODE=$?
          set -e
          
          # Check results
          echo "üìä Build completed with exit code: $BUILD_EXIT_CODE"
          
          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            # Look for IPK files
            IPK_FILES=$(find bin/packages -name "luci-app-zapret2*.ipk" 2>/dev/null || true)
            
            if [ -n "$IPK_FILES" ]; then
              echo "‚úÖ Build successful! Found IPK files:"
              echo "$IPK_FILES" | while read ipk; do
                echo "   - $ipk ($(du -h "$ipk" | cut -f1))"
              done
            else
              echo "‚ö†Ô∏è Build succeeded but no IPK files found"
              echo "Searching for any generated files..."
              find bin -type f -name "*.ipk" 2>/dev/null || echo "No IPK files found"
              exit 1
            fi
          else
            echo "‚ùå Build failed with exit code $BUILD_EXIT_CODE"
            
            # Show errors from log
            echo "=== Last 20 lines of build log ==="
            tail -20 build.log
            
            # Check for common errors
            if grep -q "ERROR:" build.log; then
              echo "=== Errors found ==="
              grep -B2 -A2 "ERROR:" build.log | head -50
            fi
            
            exit 1
          fi

      - name: Upload artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-zapret2-${{ matrix.arch.key }}
          path: |
            sdk-${{ matrix.arch.key }}/bin/packages/*/luci/luci-app-zapret2*.ipk
            sdk-${{ matrix.arch.key }}/build.log
          if-no-files-found: error
          retention-days: 7

  summary:
    runs-on: ubuntu-latest
    needs: [setup-sdk, build]
    if: always()
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: artifacts
          if-no-files-found: warn

      - name: Show build summary
        run: |
          echo "=== Build Summary ==="
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Workflow: ${{ github.workflow }}"
          echo ""
          
          echo "üìä Job Results:"
          echo "  ‚Ä¢ setup-sdk: ${{ needs.setup-sdk.result }}"
          echo "  ‚Ä¢ build: ${{ needs.build.result }}"
          echo ""
          
          # Check for artifacts
          if [ -d "artifacts" ] && [ -n "$(ls -A artifacts 2>/dev/null || true)" ]; then
            echo "‚úÖ Artifacts found:"
            find artifacts -type d -name "*luci-app-zapret2*" 2>/dev/null | while read dir; do
              echo "  üìÅ $(basename "$dir"):"
              find "$dir" -name "*.ipk" -type f 2>/dev/null | while read ipk; do
                echo "    ‚Ä¢ $(basename "$ipk") ($(du -h "$ipk" 2>/dev/null | cut -f1 2>/dev/null || echo "unknown size"))"
              done
            done
          else
            echo "üì≠ No artifacts found"
          fi
          
          echo ""
          
          # Final status
          if [ "${{ needs.build.result }}" = "success" ]; then
            echo "üéâ All builds completed successfully!"
          elif [ "${{ needs.build.result }}" = "failure" ]; then
            echo "‚ùå Some builds failed"
            echo ""
            echo "üîç Troubleshooting tips:"
            echo "  1. Check SDK download URLs"
            echo "  2. Verify Makefile structure"
            echo "  3. Check dependencies in package"
            echo "  4. Review build logs for errors"
          elif [ "${{ needs.build.result }}" = "cancelled" ]; then
            echo "‚èπÔ∏è Build was cancelled"
          elif [ "${{ needs.build.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è Build was skipped"
          else
            echo "‚ùì Unknown build status: ${{ needs.build.result }}"
          fi
          
          # Don't exit with error even if builds failed - we want to see the summary
          echo "Summary completed at: $(date)"
