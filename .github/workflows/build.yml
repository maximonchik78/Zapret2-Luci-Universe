name: Build

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download SDK
      run: |
        echo "Скачиваю SDK..."
        wget -q --show-progress -O sdk.tar.xz \
          "https://downloads.openwrt.org/releases/23.05.3/targets/x86/64/openwrt-sdk-23.05.3-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
        mkdir -p sdk
        tar -xf sdk.tar.xz -C sdk --strip-components=1
    
    - name: Copy package files
      run: |
        echo "Копирую файлы..."
        
        # ПРАВИЛЬНОЕ КОПИРОВАНИЕ: Копируем СОДЕРЖИМОЕ текущей папки
        mkdir -p sdk/package/luci-app-zapret2
        
        # Копируем ВСЕ файлы из текущей директории
        for item in *; do
          [ "$item" = "sdk" ] && continue  # Пропускаем папку sdk
          cp -r "$item" sdk/package/luci-app-zapret2/ 2>/dev/null || true
        done
        
        echo "Содержимое папки пакета:"
        ls -la sdk/package/luci-app-zapret2/
    
    - name: Build package
      run: |
        cd sdk
        
        # Обновляем feeds
        ./scripts/feeds update -a
        ./scripts/feeds install luci
        
        # Конфигурируем
        make defconfig
        
        # Включаем наш пакет
        echo "CONFIG_PACKAGE_luci-app-zapret2=y" >> .config
        
        # Собираем
        echo "Сборка luci-app-zapret2..."
        make package/luci-app-zapret2/compile V=s
        
        # Ищем результат
        echo "Ищу собранный пакет..."
        find . -name "*luci-app-zapret2*.ipk" -type f 2>/dev/null | while read f; do
          echo "✅ Найден: $f"
          echo "Размер: $(du -h "$f" | cut -f1)"
        done || echo "❌ Файлы не найдены"
    
    - name: Upload artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: luci-app-zapret2
        path: sdk/bin/**/luci-app-zapret2*.ipk
