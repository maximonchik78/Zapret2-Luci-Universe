name: Build LuCI Package

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download SDK
      run: |
        echo "üì• Downloading OpenWrt SDK..."
        wget -q --show-progress -O sdk.tar.xz \
          "https://downloads.openwrt.org/releases/23.05.3/targets/x86/64/openwrt-sdk-23.05.3-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
        
        mkdir -p sdk
        tar -xf sdk.tar.xz -C sdk --strip-components=1
        echo "SDK_PATH=$(pwd)/sdk" >> $GITHUB_ENV
    
    - name: Prepare package in SDK
      run: |
        echo "üìÅ Preparing package structure..."
        
        # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø–∞–∫–µ—Ç–∞
        PACKAGE_DIR="${{ env.SDK_PATH }}/package/network/services/luci-app-zapret2"
        mkdir -p $PACKAGE_DIR
        
        # –ö–æ–ø–∏—Ä—É–µ–º –í–°–ï —Ñ–∞–π–ª—ã –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        cp -r . $PACKAGE_DIR/
        
        # –û—á–∏—â–∞–µ–º –æ—Ç –Ω–µ–Ω—É–∂–Ω–æ–≥–æ
        rm -rf $PACKAGE_DIR/.github $PACKAGE_DIR/.git 2>/dev/null || true
        
        echo "‚úÖ Package ready at: $PACKAGE_DIR"
    
    - name: Build package
      run: |
        cd "${{ env.SDK_PATH }}"
        
        echo "üî® Starting build process..."
        
        # 1. –û–±–Ω–æ–≤–ª—è–µ–º feeds
        ./scripts/feeds update -a
        ./scripts/feeds install luci
        
        # 2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (defconfig —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É)
        make defconfig
        
        # 3. –Ø–í–ù–û –≤–∫–ª—é—á–∞–µ–º –Ω–∞—à –ø–∞–∫–µ—Ç –≤ —Å–±–æ—Ä–∫—É
        echo "CONFIG_PACKAGE_luci-app-zapret2=y" >> .config
        
        # 4. –°–æ–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞—à –ø–∞–∫–µ—Ç —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
        echo "üèóÔ∏è Building luci-app-zapret2..."
        make package/network/services/luci-app-zapret2/compile V=s 2>&1 | tee build.log
        
        # 5. –ü–æ–∏—Å–∫ —Å–æ–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–∞–∫–µ—Ç–∞
        echo "üîç Searching for built package..."
        IPK_FILE=$(find bin -name "*luci-app-zapret2*.ipk" -type f 2>/dev/null | head -1)
        
        if [ -f "$IPK_FILE" ]; then
          echo "‚úÖ BUILD SUCCESSFUL!"
          echo "üì¶ Package: $(basename $IPK_FILE)"
          echo "üìè Size: $(du -h "$IPK_FILE" | cut -f1)"
          echo "üìç Path: $IPK_FILE"
          echo "SDK_IPK_PATH=$IPK_FILE" >> $GITHUB_ENV
        else
          echo "‚ùå BUILD FAILED - No IPK file found"
          echo "=== Build log errors ==="
          grep -i "error\|failed\|undefined" build.log | head -20
          echo "=== Full log available in artifacts ==="
          exit 1
        fi
    
    - name: Upload artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: luci-app-zapret2
        path: ${{ env.SDK_PATH }}/bin/packages/*/*/luci-app-zapret2*.ipk
    
    - name: Upload build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log
        path: ${{ env.SDK_PATH }}/build.log
