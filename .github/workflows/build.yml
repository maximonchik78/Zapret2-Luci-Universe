name: Build LuCI Package for OpenWrt

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      target_arch:
        description: 'Target architecture'
        required: true
        default: 'x86_64'
        type: choice
        options:
          - x86_64
          - aarch64
          - mipsel

env:
  OPENWRT_VERSION: "23.05.3"

jobs:
  build:
    runs-on: ubuntu-latest
    
    # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ matrix Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ñ‚Ğ¸Ğ¿Ğ° ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ
    strategy:
      ${{ if eq(github.event_name, 'workflow_dispatch') }}:
        matrix:
          target: [${{ github.event.inputs.target_arch }}]
      ${{ if ne(github.event_name, 'workflow_dispatch') }}:
        matrix:
          target: [x86_64]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          echo "ğŸ¯ Building for: ${{ matrix.target }}"
          echo "ğŸ“¦ OpenWrt version: ${{ env.OPENWRT_VERSION }}"
          
          # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ URL SDK Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹
          case "${{ matrix.target }}" in
            x86_64)
              SDK_URL="https://downloads.openwrt.org/releases/${{ env.OPENWRT_VERSION }}/targets/x86/64/openwrt-sdk-${{ env.OPENWRT_VERSION }}-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
              ;;
            aarch64)
              SDK_URL="https://downloads.openwrt.org/releases/${{ env.OPENWRT_VERSION }}/targets/armvirt/64/openwrt-sdk-${{ env.OPENWRT_VERSION }}-aarch64_generic_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
              ;;
            mipsel)
              SDK_URL="https://downloads.openwrt.org/releases/${{ env.OPENWRT_VERSION }}/targets/ramips/mt7621/openwrt-sdk-${{ env.OPENWRT_VERSION }}-ramips-mt7621_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
              ;;
            *)
              echo "âŒ Unsupported architecture: ${{ matrix.target }}"
              exit 1
              ;;
          esac
          
          echo "ğŸ“¥ SDK URL: $SDK_URL"
          echo "SDK_URL=$SDK_URL" >> $GITHUB_ENV

      - name: Download and extract OpenWrt SDK
        run: |
          echo "ğŸ“¦ Downloading SDK..."
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ»Ñ SDK
          SDK_DIR="openwrt-sdk-${{ matrix.target }}"
          mkdir -p $SDK_DIR
          
          # Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ SDK
          echo "Downloading from: ${{ env.SDK_URL }}"
          wget -q --show-progress -O sdk.tar.xz "${{ env.SDK_URL }}"
          
          # Ğ Ğ°ÑĞ¿Ğ°ĞºĞ¾Ğ²Ñ‹Ğ²Ğ°ĞµĞ¼
          echo "Extracting SDK..."
          tar -xf sdk.tar.xz -C $SDK_DIR --strip-components=1
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼
          if [ -f "$SDK_DIR/Makefile" ]; then
            echo "âœ… SDK extracted successfully"
            echo "SDK directory contents:"
            ls -la $SDK_DIR/
          else
            echo "âŒ SDK extraction failed"
            echo "Current directory: $(pwd)"
            echo "SDK_DIR: $SDK_DIR"
            ls -la
            exit 1
          fi
          
          echo "SDK_DIR=$SDK_DIR" >> $GITHUB_ENV

      - name: Prepare package
        run: |
          echo "ğŸ“ Preparing package..."
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿Ğ°ĞºĞµÑ‚Ğ° Ğ² SDK
          PACKAGE_DIR="${{ env.SDK_DIR }}/package/luci-app-zapret2"
          mkdir -p $PACKAGE_DIR
          
          # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
          echo "Copying Makefile..."
          if [ -f "Makefile" ]; then
            cp Makefile $PACKAGE_DIR/
            echo "âœ… Makefile copied"
          else
            echo "âŒ Makefile not found in repository"
            exit 1
          fi
          
          # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ files ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ° ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚
          if [ -d "files" ]; then
            echo "Copying files directory..."
            cp -r files $PACKAGE_DIR/
            echo "âœ… files directory copied"
          else
            echo "âš ï¸  files directory not found"
          fi
          
          # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
          for file in README.md LICENSE; do
            if [ -f "$file" ]; then
              cp "$file" $PACKAGE_DIR/ 2>/dev/null || true
            fi
          done
          
          echo "âœ… Package prepared"
          echo "Package directory: $PACKAGE_DIR"
          ls -la $PACKAGE_DIR/

      - name: Build the package
        run: |
          echo "ğŸ”¨ Building package..."
          cd "${{ env.SDK_DIR }}"
          
          # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ feeds
          echo "ğŸ“¡ Updating feeds..."
          ./scripts/feeds update -a
          
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ luci feed
          echo "ğŸ“¥ Installing luci feed..."
          ./scripts/feeds install luci
          
          # ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ¸Ñ€ÑƒĞµĞ¼
          echo "âš™ï¸ Configuring..."
          make defconfig
          
          # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ°Ñˆ Ğ¿Ğ°ĞºĞµÑ‚
          echo "ğŸ—ï¸ Building luci-app-zapret2..."
          
          # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒÑ Ğ»Ğ¾Ğ³Ğ°
          make package/luci-app-zapret2/compile V=s 2>&1 | tee build.log
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
          echo "ğŸ” Checking build results..."
          IPK_FILES=$(find bin -name "luci-app-zapret2*.ipk" 2>/dev/null || true)
          
          if [ -n "$IPK_FILES" ]; then
            echo "âœ… Build successful!"
            echo "ğŸ“¦ Generated packages:"
            echo "$IPK_FILES" | while read ipk; do
              SIZE=$(du -h "$ipk" 2>/dev/null | cut -f1 || echo "unknown")
              echo "  - $ipk ($SIZE)"
            done
          else
            echo "âŒ Build failed - no .ipk files generated"
            echo "=== Searching for any build artifacts ==="
            find bin -type f -name "*.ipk" 2>/dev/null || echo "No IPK files found"
            
            echo "=== Last 100 lines of build log ==="
            tail -100 build.log
            
            echo "=== Looking for errors in build log ==="
            grep -i "error\|failed\|undefined" build.log | head -50
            
            exit 1
          fi

      - name: Upload built package
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-zapret2-${{ matrix.target }}
          path: ${{ env.SDK_DIR }}/bin/**/luci-app-zapret2*.ipk
          retention-days: 7

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.target }}
          path: ${{ env.SDK_DIR }}/build.log
          retention-days: 7

  summary:
    runs-on: ubuntu-latest
    needs: [build]
    if: always()
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: artifacts

      - name: Show build summary
        run: |
          echo "=== Build Summary ==="
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Workflow: ${{ github.workflow }}"
          echo ""
          
          echo "ğŸ“Š Job Results:"
          echo "  â€¢ build: ${{ needs.build.result }}"
          echo ""
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ğ²
          if [ -d "artifacts" ]; then
            IPK_COUNT=$(find artifacts -name "*.ipk" -type f 2>/dev/null | wc -l)
            if [ $IPK_COUNT -gt 0 ]; then
              echo "âœ… Built $IPK_COUNT package(s):"
              find artifacts -name "*.ipk" -type f | while read ipk; do
                SIZE=$(du -h "$ipk" 2>/dev/null | cut -f1 || echo "unknown")
                ARCH=$(basename $(dirname $ipk) | sed 's/luci-app-zapret2-//')
                echo "  - $ARCH: $(basename $ipk) ($SIZE)"
              done
            else
              echo "ğŸ“­ No packages found in artifacts"
              echo "Available files in artifacts:"
              find artifacts -type f | head -20
            fi
          else
            echo "ğŸ“­ No artifacts directory found"
          fi
          
          echo ""
          
          # Final status
          if [ "${{ needs.build.result }}" = "success" ]; then
            echo "ğŸ‰ Build completed successfully!"
            echo ""
            echo "ğŸ“¦ Packages are available in the 'Artifacts' section above."
          else
            echo "âŒ Build failed"
            echo ""
            echo "ğŸ”§ Troubleshooting steps:"
            echo "  1. Check build logs in artifacts"
            echo "  2. Verify SDK URLs are correct"
            echo "  3. Check Makefile structure"
            echo "  4. Ensure all required files are in repository"
          fi
          
          echo ""
          echo "Summary completed at: $(date)"
