name: Build LuCI Package

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      target:
        description: 'Target architecture'
        required: true
        default: 'x86_64'
        type: choice
        options:
          - x86_64
          - aarch64
          - mipsel

env:
  OPENWRT_VERSION: "23.05.3"

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target: ["x86_64", "aarch64"] # –°–±–æ—Ä–∫–∞ –¥–ª—è –¥–≤—É—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup OpenWrt SDK
        run: |
          echo "üîÑ Setting up OpenWrt SDK for ${{ matrix.target }}"
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º URL SDK –ø–æ —Ü–µ–ª–µ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ (–∫–∞–∫ —É remittor)
          case "${{ matrix.target }}" in
            x86_64)
              SDK_URL="https://downloads.openwrt.org/releases/${{ env.OPENWRT_VERSION }}/targets/x86/64/openwrt-sdk-${{ env.OPENWRT_VERSION }}-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
              ;;
            aarch64)
              SDK_URL="https://downloads.openwrt.org/releases/${{ env.OPENWRT_VERSION }}/targets/armvirt/64/openwrt-sdk-${{ env.OPENWRT_VERSION }}-aarch64_generic_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
              ;;
            mipsel)
              SDK_URL="https://downloads.openwrt.org/releases/${{ env.OPENWRT_VERSION }}/targets/ramips/mt7621/openwrt-sdk-${{ env.OPENWRT_VERSION }}-ramips-mt7621_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
              ;;
            *)
              echo "‚ùå Unsupported target"
              exit 1
              ;;
          esac
          
          echo "üì• Downloading SDK from: $SDK_URL"
          wget -q --show-progress -O sdk.tar.xz "$SDK_URL"
          
          echo "üì¶ Extracting SDK..."
          tar -xf sdk.tar.xz
          mv openwrt-sdk-* openwrt-sdk
          echo "SDK_PATH=$(pwd)/openwrt-sdk" >> $GITHUB_ENV
          echo "‚úÖ SDK ready"

      - name: Prepare Package in SDK Tree
        run: |
          echo "üìÅ Copying package to SDK tree..."
          mkdir -p ${{ env.SDK_PATH }}/package/network/services
          # –ö–æ–ø–∏—Ä—É–µ–º –í–°–ï —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –≤ –ø–æ–¥–ø–∞–ø–∫—É SDK
          cp -r $GITHUB_WORKSPACE ${{ env.SDK_PATH }}/package/network/services/luci-app-zapret2
          echo "‚úÖ Package prepared"

      - name: Build Package with SDK
        run: |
          cd ${{ env.SDK_PATH }}
          echo "üèóÔ∏è Starting build for luci-app-zapret2..."
          
          # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ feeds –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å)
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          make defconfig
          
          # –°–±–æ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ –Ω–∞—à–µ–≥–æ –ø–∞–∫–µ—Ç–∞. V=sc –¥–∞–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥.
          make package/network/services/luci-app-zapret2/compile V=sc 2>&1 | tee build_output.log
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–æ–±—Ä–∞–Ω–Ω–æ–≥–æ .ipk —Ñ–∞–π–ª–∞
          if find bin -name "luci-app-zapret2*.ipk" 2>/dev/null | grep -q .; then
            echo "‚úÖ Build SUCCESSFUL!"
            find bin -name "*.ipk" | xargs ls -lah
          else
            echo "‚ùå Build FAILED. Last 50 lines of log:"
            tail -50 build_output.log
            exit 1
          fi

      - name: Upload Built Package as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-zapret2-${{ matrix.target }}
          path: ${{ env.SDK_PATH }}/bin/packages/*/luci/luci-app-zapret2*.ipk
          retention-days: 7

      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ matrix.target }}
          path: ${{ env.SDK_PATH }}/build_output.log
          retention-days: 7
