name: Build LuCI Package for OpenWrt

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      target_arch:
        description: 'Target architecture'
        required: true
        default: 'x86_64'
        type: choice
        options:
          - x86_64
          - aarch64

env:
  OPENWRT_VERSION: "23.05.3"

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          echo "üì¶ Installing build dependencies..."
          sudo apt-get update
          sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk \
            gettext git java-propose-classpath libelf-dev libncurses5-dev \
            libncursesw5-dev libssl-dev python3 python3-dev python3-setuptools \
            rsync subversion swig time xsltproc zlib1g-dev unzip wget

      - name: Determine target architecture
        id: set-arch
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "TARGET_ARCH=${{ github.event.inputs.target_arch }}" >> $GITHUB_OUTPUT
          else
            echo "TARGET_ARCH=x86_64" >> $GITHUB_OUTPUT
          fi
          echo "Target architecture: $TARGET_ARCH"

      - name: Setup environment
        run: |
          echo "üéØ Building for: ${{ steps.set-arch.outputs.TARGET_ARCH }}"
          echo "üì¶ OpenWrt version: ${{ env.OPENWRT_VERSION }}"
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º URL SDK –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
          TARGET="${{ steps.set-arch.outputs.TARGET_ARCH }}"
          if [[ "$TARGET" == "x86_64" ]]; then
            SDK_URL="https://downloads.openwrt.org/releases/${{ env.OPENWRT_VERSION }}/targets/x86/64/openwrt-sdk-${{ env.OPENWRT_VERSION }}-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
          elif [[ "$TARGET" == "aarch64" ]]; then
            SDK_URL="https://downloads.openwrt.org/releases/${{ env.OPENWRT_VERSION }}/targets/armvirt/64/openwrt-sdk-${{ env.OPENWRT_VERSION }}-aarch64_generic_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
          else
            echo "‚ùå Unsupported architecture: $TARGET"
            exit 1
          fi
          
          echo "üì• SDK URL: $SDK_URL"
          echo "SDK_URL=$SDK_URL" >> $GITHUB_ENV
          echo "TARGET_ARCH=$TARGET" >> $GITHUB_ENV

      - name: Download and extract OpenWrt SDK
        run: |
          echo "üì¶ Downloading SDK..."
          
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è SDK
          SDK_DIR="openwrt-sdk"
          mkdir -p $SDK_DIR
          
          # –ó–∞–≥—Ä—É–∂–∞–µ–º SDK
          echo "Downloading from: $SDK_URL"
          wget --timeout=30 --tries=3 --show-progress -O sdk.tar.xz "$SDK_URL"
          
          # –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º
          echo "Extracting SDK..."
          tar -xf sdk.tar.xz -C $SDK_DIR --strip-components=1
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º
          if [ -f "$SDK_DIR/Makefile" ]; then
            echo "‚úÖ SDK extracted successfully"
            echo "SDK location: $(pwd)/$SDK_DIR"
          else
            echo "‚ùå SDK extraction failed"
            ls -la $SDK_DIR/
            exit 1
          fi
          
          echo "SDK_DIR=$SDK_DIR" >> $GITHUB_ENV

      - name: Prepare package
        run: |
          echo "üìÅ Preparing package..."
          
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø–∞–∫–µ—Ç–∞ –≤ SDK
          PACKAGE_DIR="$SDK_DIR/package/luci-app-zapret2"
          mkdir -p $PACKAGE_DIR
          
          # –ö–æ–ø–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã
          echo "Copying Makefile..."
          if [ -f "Makefile" ]; then
            cp Makefile $PACKAGE_DIR/
            echo "‚úÖ Makefile copied"
          else
            echo "‚ùå Makefile not found in repository"
            exit 1
          fi
          
          # –ö–æ–ø–∏—Ä—É–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é files –µ—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          if [ -d "files" ]; then
            echo "Copying files directory..."
            cp -r files $PACKAGE_DIR/
            echo "‚úÖ files directory copied"
          else
            echo "‚ö†Ô∏è  files directory not found"
          fi
          
          echo "‚úÖ Package prepared"
          echo "Package directory: $PACKAGE_DIR"
          ls -la $PACKAGE_DIR/

      - name: Configure and build
        run: |
          echo "üî® Configuring and building package..."
          cd "$SDK_DIR"
          
          # –û–±–Ω–æ–≤–ª—è–µ–º feeds
          echo "üì° Updating feeds..."
          ./scripts/feeds update -a
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º luci feed
          echo "üì• Installing luci feed..."
          ./scripts/feeds install luci
          
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
          echo "‚öôÔ∏è Configuring build system..."
          # –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
          cat > .config << 'EOF'
          CONFIG_TARGET_x86=y
          CONFIG_TARGET_x86_64=y
          CONFIG_TARGET_x86_64_DEVICE_generic=y
          EOF
          
          # –í—ã–ø–æ–ª–Ω—è–µ–º defconfig
          make defconfig
          
          # –°–æ–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞—à –ø–∞–∫–µ—Ç
          echo "üèóÔ∏è Building luci-app-zapret2..."
          
          # –°–æ–±–∏—Ä–∞–µ–º —Å –∑–∞–ø–∏—Å—å—é –ª–æ–≥–∞
          make package/luci-app-zapret2/compile -j1 V=sc 2>&1 | tee build.log
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          echo "üîç Checking build results..."
          if find bin -name "luci-app-zapret2*.ipk" 2>/dev/null | grep -q .; then
            echo "‚úÖ Build successful!"
            echo "üì¶ Generated packages:"
            find bin -name "luci-app-zapret2*.ipk" | while read ipk; do
              SIZE=$(du -h "$ipk" 2>/dev/null | cut -f1 || echo "unknown")
              echo "  - $ipk ($SIZE)"
            done
          else
            echo "‚ùå Build failed - no .ipk files generated"
            echo "=== Searching for any build artifacts ==="
            find bin -type f 2>/dev/null || echo "No files in bin directory"
            
            echo "=== Last 100 lines of build log ==="
            tail -100 build.log
            
            echo "=== Looking for errors in build log ==="
            grep -i "error\|failed\|undefined\|No rule to make target" build.log | head -50
            
            exit 1
          fi

      - name: Upload built package
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-zapret2-${{ env.TARGET_ARCH }}
          path: ${{ env.SDK_DIR }}/bin/**/luci-app-zapret2*.ipk
          retention-days: 7

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ env.TARGET_ARCH }}
          path: ${{ env.SDK_DIR }}/build.log
          retention-days: 7

  summary:
    runs-on: ubuntu-22.04
    needs: [build]
    if: always()
    steps:
      - name: Show build summary
        run: |
          echo "=== Build Summary ==="
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo ""
          
          echo "Target architecture: ${{ env.TARGET_ARCH }}"
          echo "OpenWrt version: ${{ env.OPENWRT_VERSION }}"
          echo ""
          
          echo "Build result: ${{ needs.build.result }}"
          
          if [ "${{ needs.build.result }}" = "success" ]; then
            echo "üéâ Build completed successfully!"
            echo ""
            echo "üì¶ Package is available in the 'Artifacts' section above."
          else
            echo "‚ùå Build failed"
            echo ""
            echo "üîß Common issues and solutions:"
            echo "  1. Check that SDK URLs are correct"
            echo "  2. Verify Makefile structure"
            echo "  3. Ensure all dependencies are installed"
            echo "  4. Check build logs in artifacts"
          fi
