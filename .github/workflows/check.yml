name: Code Quality Check

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Lua environment
        run: |
          echo "üì¶ Installing Lua and dependencies..."
          sudo apt-get update
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Lua 5.1 (—Å–æ–≤–º–µ—Å—Ç–∏–º—É—é —Å OpenWrt)
          sudo apt-get install -y lua5.1 lua5.1-dev
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º shellcheck –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ shell —Å–∫—Ä–∏–ø—Ç–æ–≤
          sudo apt-get install -y shellcheck
          echo "‚úÖ Dependencies installed"
      
      - name: Lua syntax check
        run: |
          echo "üîß Checking Lua syntax..."
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å luac
          if command -v luac &> /dev/null; then
            echo "Using $(luac -v 2>&1 | head -1)"
          else
            echo "‚ùå luac not found, trying lua5.1"
            # –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å lua5.1 –Ω–∞–ø—Ä—è–º—É—é
            sudo ln -s /usr/bin/lua5.1 /usr/local/bin/lua || true
            sudo ln -s /usr/bin/luac5.1 /usr/local/bin/luac || true
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –≤—Å–µ—Ö Lua —Ñ–∞–π–ª–æ–≤
          ERROR_COUNT=0
          find . -name "*.lua" -type f | while read file; do
            echo "Checking: $file"
            if luac -p "$file" 2>/dev/null; then
              echo "  ‚úÖ Syntax OK"
            else
              echo "  ‚ùå Syntax error in $file"
              # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
              luac -p "$file" 2>&1 | sed 's/^/    /' || true
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
          done
          
          if [ $ERROR_COUNT -gt 0 ]; then
            echo "‚ùå Found $ERROR_COUNT Lua syntax error(s)"
            exit 1
          else
            echo "‚úÖ All Lua files have correct syntax"
          fi
      
      - name: Shell script check
        run: |
          echo "üîß Checking shell scripts..."
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º shellcheck –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ shell —Å–∫—Ä–∏–ø—Ç–æ–≤
          find . -name "*.sh" -type f | while read file; do
            echo "Checking: $file"
            if shellcheck --format=gcc "$file" 2>/dev/null; then
              echo "  ‚úÖ shellcheck passed"
            else
              echo "  ‚ö†Ô∏è  shellcheck warnings/errors"
              shellcheck "$file" 2>&1 | sed 's/^/    /' || true
            fi
          done
      
      - name: YAML syntax check
        run: |
          echo "üîß Checking YAML files..."
          ERROR_COUNT=0
          find . \( -name "*.yml" -o -name "*.yaml" \) -type f | while read file; do
            echo "Checking: $file"
            if python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
              echo "  ‚úÖ YAML syntax OK"
            else
              echo "  ‚ùå YAML syntax error in $file"
              python3 -c "import yaml, sys; yaml.safe_load(open(sys.argv[1]))" "$file" 2>&1 | sed 's/^/    /' || true
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
          done
          
          if [ $ERROR_COUNT -gt 0 ]; then
            echo "‚ùå Found $ERROR_COUNT YAML syntax error(s)"
            exit 1
          else
            echo "‚úÖ All YAML files have correct syntax"
          fi
      
      - name: Makefile validation
        run: |
          echo "üîß Checking Makefile structure..."
          if [ -f "Makefile" ]; then
            echo "Checking main Makefile..."
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
            REQUIRED_VARS=("PKG_NAME" "PKG_VERSION" "PKG_RELEASE" "LUCI_TITLE")
            MISSING_VARS=()
            
            for var in "${REQUIRED_VARS[@]}"; do
              if ! grep -q "^$var\s*:=" Makefile && ! grep -q "^$var\s*=" Makefile; then
                MISSING_VARS+=("$var")
              fi
            done
            
            if [ ${#MISSING_VARS[@]} -gt 0 ]; then
              echo "‚ùå Missing required variables in Makefile: ${MISSING_VARS[*]}"
              exit 1
            else
              echo "‚úÖ Makefile has all required variables"
            fi
          else
            echo "‚ö†Ô∏è  Makefile not found"
          fi
      
      - name: Repository structure check
        run: |
          echo "üìÅ Checking repository structure..."
          
          # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
          CRITICAL_FILES=(
            "files/usr/lib/lua/luci/controller/zapret2.lua"
            "files/usr/lib/lua/luci/model/cbi/zapret2.lua"
          )
          
          for file in "${CRITICAL_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file exists"
            else
              echo "‚ö†Ô∏è  $file not found (might be expected for your structure)"
            fi
          done
